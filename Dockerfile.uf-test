FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# üîß –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ + rsyslog + openssh-server + —É—Ç–∏–ª—ñ—Ç–∏
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      wget curl gnupg2 apt-transport-https ca-certificates lsb-release \
      rsyslog openssh-server dnsutils procps iproute2 net-tools sudo iputils-ping sshpass logger && \
    rm -rf /var/lib/apt/lists/*

# üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Splunk Universal Forwarder (–∑–∞—Ä–∞–∑ —É —Ç–µ–±–µ 10.0.0)
# –Ø–∫—â–æ URL –∑–º—ñ–Ω–∏—Ç—å—Å—è ‚Äî –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Ä–æ–±–æ—á–∏–π –ª—ñ–Ω–∫
RUN wget -O /tmp/splunkforwarder.tgz 'https://download.splunk.com/products/universalforwarder/releases/10.0.0/linux/splunkforwarder-10.0.0-e8eb0c4654f8-linux-amd64.tgz' && \
    tar -xvzf /tmp/splunkforwarder.tgz -C /tmp && \
    mv /tmp/splunkforwarder /opt/splunkforwarder && \
    rm /tmp/splunkforwarder.tgz || true

# üîê –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SSH: —Å—Ç–≤–æ—Ä–∏–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –¥–ª—è runtime –∫–ª—é—á—ñ–≤ —ñ –¥–æ–∑–≤–æ–ª–∏–º–æ –ø–∞—Ä–æ–ª—å–Ω—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é
RUN mkdir -p /run/sshd && \
    sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config || true

# ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–∫—Ä–∏–ø—Ç—É –∑–∞–ø—É—Å–∫—É (entrypoint) ‚Äî —Ç–∏ –Ω–∞–¥–∞—Å–∏ —Å–≤—ñ–π —Ä–æ–±–æ—á–∏–π entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# üõ° –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ—Ä—Ç—ñ–≤
EXPOSE 22        # SSH –¥–ª—è —Ç–µ—Å—Ç—ñ–≤ –±—Ä—É—Ç—Ñ–æ—Ä—Å—É (–º–∞–ø–∏–º–æ –Ω–∞ —Ö–æ—Å—Ç —É docker-compose)
EXPOSE 8089 9997 # UF/management & forwarder port

# üìç –†–æ–±–æ—á–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è
WORKDIR /opt/splunkforwarder

# üöÄ –ó–∞–ø—É—Å–∫ Forwarder –∑ –∞–≤—Ç–æ–∫–æ–Ω—Ñ—ñ–≥–æ–º —á–µ—Ä–µ–∑ entrypoint
ENTRYPOINT ["/entrypoint.sh"]
